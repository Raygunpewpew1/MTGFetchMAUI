name: Update Trimmed MTG Database

on:
  schedule:
    # Runs automatically every Tuesday at 12:00 UTC
    - cron: '0 12 * * 2' 
  workflow_dispatch: # Allows you to click a button in GitHub to run it manually

jobs:
  trim-and-host:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required so the bot can upload the zip file to Releases

    steps:
      - name: Generate Release Tag
        id: date
        run: echo "tag=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Download Raw MTGJSON SQLite File
        run: curl -L -o AllPrintings.sqlite "https://mtgjson.com/api/v5/AllPrintings.sqlite"

      - name: Drop Heavy Tables & Vacuum
        run: |
          sqlite3 AllPrintings.sqlite <<EOF
          DROP TABLE IF EXISTS cardForeignData;
          DROP TABLE IF EXISTS cardPurchaseUrls;
          VACUUM;
          EOF

      - name: Zip the Final Database
        run: zip MTG_App_DB.zip AllPrintings.sqlite

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.date.outputs.tag }}
          name: MTG Database Update (${{ steps.date.outputs.tag }})
          files: MTG_App_DB.zip
          make_latest: true
