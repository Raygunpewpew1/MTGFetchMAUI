name: Update Trimmed MTG Database
on:
  schedule:
    - cron: '0 12 * * 2'
  workflow_dispatch:
jobs:
  trim-and-host:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Generate Release Tag
        id: date
        run: echo "tag=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Download MTGJSON SQLite Zip
        run: curl -L -o AllPrintings.sql.zip "https://mtgjson.com/api/v5/AllPrintings.sql.zip"

      - name: Extract Database
        run: unzip AllPrintings.sql.zip

      - name: Drop Heavy Tables & Vacuum
        run: |
          sqlite3 AllPrintings.sqlite <<EOF
          DROP TABLE IF EXISTS cardForeignData;
          VACUUM;
          EOF

      - name: Zip the Final Database
        run: zip -9 MTG_App_DB.zip AllPrintings.sqlite

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.date.outputs.tag }}
          name: MTG Database Update (${{ steps.date.outputs.tag }})
          files: MTG_App_DB.zip
          make_latest: true

      - name: Delete Old Releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
